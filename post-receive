#!/bin/bash

# Git Post-Receive Hook for cPanel Deployment
# Automatically deploys Tamil Status Creator when pushing to master branch

REPO_DIR="/home/statusdreamcoder/repo.git"
LIVE_DIR="/home/statusdreamcoder/live"
BRANCH="master"

echo "ğŸš€ Starting deployment process..."

# Check if the push is for the master branch
while read oldrev newrev refname; do
    branch=$(git rev-parse --symbolic --abbrev-ref $refname)
    if [ "$branch" = "$BRANCH" ]; then
        echo "ğŸ“¥ Received push to $BRANCH branch"
        
        # Deploy new version
        echo "ğŸ“‚ Checking out files to live directory..."
        git --git-dir=$REPO_DIR --work-tree=$LIVE_DIR checkout -f $BRANCH
        
        # Enter live directory and run deployment
        cd "$LIVE_DIR"
        
        # Check if backend directory exists
        if [ -d "backend" ]; then
            cd backend
            
            echo "ğŸ”§ Running deployment script..."
            if [ -f "deploy.sh" ]; then
                chmod +x deploy.sh
                ./deploy.sh
            else
                echo "âš ï¸  deploy.sh not found, running manual deployment..."
                
                # Manual deployment steps
                echo "ğŸ“¦ Installing production dependencies..."
                composer install --optimize-autoloader --no-dev --no-interaction
                
                echo "ğŸ§¹ Clearing and caching configurations..."
                php artisan config:clear
                php artisan route:clear
                php artisan view:clear
                php artisan cache:clear
                php artisan config:cache
                php artisan route:cache
                php artisan view:cache
                
                echo "ğŸ—„ï¸  Running database migrations..."
                php artisan migrate --force --no-interaction
                
                echo "ğŸ”— Creating storage symbolic link..."
                php artisan storage:link
                
                echo "ğŸ”’ Setting proper file permissions..."
                find . -type f -exec chmod 644 {} \;
                find . -type d -exec chmod 755 {} \;
                chmod -R 775 storage bootstrap/cache
                
                echo "âš¡ Optimizing application..."
                php artisan optimize:clear
            fi
            
            echo "âœ… Deployment completed successfully!"
            echo "ğŸŒ Your application should now be live at: https://status.dreamcoderz.com"
        else
            echo "âŒ Backend directory not found!"
            exit 1
        fi
    else
        echo "â„¹ï¸  Push to $branch branch ignored (only $BRANCH branch triggers deployment)"
    fi
done

echo "âœ… Deployment completed successfully!"
echo "ğŸŒ Live at: https://status.dreamcoderz.com"